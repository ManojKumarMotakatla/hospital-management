<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard — MediCare</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --brand:#0050ff; --surface:#f4f7fc;
    --text:#0f172a;  --muted:#64748b;
    --sidebar:#0f172a; --radius:14px;
  }
  *, *::before, *::after { box-sizing:border-box; }
  body { font-family:'Plus Jakarta Sans',sans-serif; background:var(--surface); color:var(--text); margin:0; }

  /* ── Sidebar ─────── */
  .sidebar {
    width: 240px; min-height:100vh; position:fixed; left:0; top:0;
    background:var(--sidebar); color:#fff;
    display:flex; flex-direction:column; z-index:100;
  }
  .sidebar-brand {
    padding:1.4rem 1.2rem 1rem;
    font-weight:800; font-size:1.15rem; color:#fff;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .sidebar-brand i { color:#60a5fa; }
  .sidebar-nav { padding:.5rem .75rem; flex:1; }
  .sidebar-nav .nav-item { margin:.15rem 0; }
  .sidebar-nav .nav-link {
    color:rgba(255,255,255,.65); border-radius:8px;
    padding:.55rem .85rem; font-weight:600; font-size:.88rem;
    display:flex; align-items:center; gap:.6rem;
    transition:all .15s;
  }
  .sidebar-nav .nav-link:hover, .sidebar-nav .nav-link.active {
    background:rgba(255,255,255,.1); color:#fff;
  }
  .sidebar-nav .nav-link.active { background:var(--brand); color:#fff; }
  .sidebar-footer { padding:.75rem; border-top:1px solid rgba(255,255,255,.08); }

  /* ── Main ─────────── */
  .main-area { margin-left:240px; min-height:100vh; }
  .topbar {
    background:#fff; border-bottom:1px solid #e2e8f0;
    padding:.8rem 1.5rem; position:sticky; top:0; z-index:99;
    display:flex; align-items:center; gap:1rem;
  }
  .topbar-title { font-weight:800; font-size:1.1rem; margin:0; }
  .content { padding:1.5rem; }

  /* ── Stat cards ──── */
  .stat-card {
    background:#fff; border:1px solid #e2e8f0;
    border-radius:var(--radius); padding:1.25rem 1.4rem;
    display:flex; align-items:center; gap:1rem;
  }
  .stat-icon {
    width:48px; height:48px; border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    font-size:1.3rem; flex-shrink:0;
  }
  .stat-num  { font-size:1.8rem; font-weight:800; line-height:1; }
  .stat-lbl  { font-size:.75rem; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; }

  /* ── Tables ──────── */
  .data-card { background:#fff; border:1px solid #e2e8f0; border-radius:var(--radius); overflow:hidden; }
  .data-card-header {
    padding:.9rem 1.2rem; border-bottom:1px solid #e2e8f0;
    display:flex; align-items:center; gap:.75rem; background:#fff;
  }
  .data-card-header h6 { margin:0; font-weight:700; font-size:.95rem; }
  .table { margin:0; }
  .table thead th { background:#f8fafc; font-size:.78rem; font-weight:700; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); border-bottom:1px solid #e2e8f0; }
  .table td { vertical-align:middle; font-size:.875rem; }
  .btn-xs { padding:.2rem .5rem; font-size:.75rem; }
  .badge  { font-weight:600; }

  /* ── Section tabs ─── */
  .section-tabs { display:flex; gap:.5rem; margin-bottom:1rem; flex-wrap:wrap; }
  .section-tabs button { border:1px solid #e2e8f0; background:#fff; border-radius:50px; padding:.35rem .9rem; font-size:.82rem; font-weight:600; color:var(--muted); cursor:pointer; }
  .section-tabs button.active { background:var(--brand); border-color:var(--brand); color:#fff; }

  /* ── Responsive ────── */
  @media (max-width:768px) {
    .sidebar { display:none; }
    .main-area { margin-left:0; }
  }
</style>
</head>
<body>

<!-- ══ SIDEBAR ══════════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <i class="bi bi-hospital-fill me-2"></i>MediCare Admin
  </div>
  <nav class="sidebar-nav">
    <ul class="nav flex-column">
      <li class="nav-item">
        <a href="#overview" class="nav-link active" onclick="showSection('overview',this)">
          <i class="bi bi-speedometer2"></i> Overview
        </a>
      </li>
      <li class="nav-item">
        <a href="#appointments" class="nav-link" onclick="showSection('appointments',this)">
          <i class="bi bi-calendar-check"></i> Appointments
        </a>
      </li>
      <li class="nav-item">
        <a href="#patients" class="nav-link" onclick="showSection('patients',this)">
          <i class="bi bi-people"></i> Patients
        </a>
      </li>
      <li class="nav-item">
        <a href="add-patient.html" class="nav-link">
          <i class="bi bi-person-plus"></i> Add Patient
        </a>
      </li>
      <li class="nav-item mt-2">
        <a href="../main.html" class="nav-link">
          <i class="bi bi-house"></i> Main Site
        </a>
      </li>
    </ul>
  </nav>
  <div class="sidebar-footer">
    <span class="text-white-50 small">MediCare HMS v2.0</span>
  </div>
</aside>

<!-- ══ MAIN ══════════════════════════════════════════════════ -->
<div class="main-area">
  <div class="topbar">
    <h6 class="topbar-title me-auto" id="topbarTitle">Overview</h6>
    <button class="btn btn-primary btn-sm fw-semibold" onclick="refreshAll()">
      <i class="bi bi-arrow-clockwise me-1"></i>Refresh
    </button>
  </div>

  <div class="content">

    <!-- ── OVERVIEW ───────────────────────────────────────── -->
    <div id="sectionOverview">
      <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-icon bg-primary bg-opacity-10">
              <i class="bi bi-people text-primary"></i>
            </div>
            <div>
              <div class="stat-num text-primary" id="totalPatients">0</div>
              <div class="stat-lbl">Patients</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-icon bg-info bg-opacity-10">
              <i class="bi bi-calendar-check text-info"></i>
            </div>
            <div>
              <div class="stat-num text-info" id="totalAppts">0</div>
              <div class="stat-lbl">Total Appts</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-icon bg-success bg-opacity-10">
              <i class="bi bi-check-circle text-success"></i>
            </div>
            <div>
              <div class="stat-num text-success" id="visitedCount">0</div>
              <div class="stat-lbl">Visited</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-icon bg-primary bg-opacity-10">
              <i class="bi bi-calendar text-primary"></i>
            </div>
            <div>
              <div class="stat-num text-primary" id="bookedCount">0</div>
              <div class="stat-lbl">Booked</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-icon bg-warning bg-opacity-10">
              <i class="bi bi-clock-history text-warning"></i>
            </div>
            <div>
              <div class="stat-num text-warning" id="postponedCount">0</div>
              <div class="stat-lbl">Postponed</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-icon bg-danger bg-opacity-10">
              <i class="bi bi-x-circle text-danger"></i>
            </div>
            <div>
              <div class="stat-num text-danger" id="notVisitedCount">0</div>
              <div class="stat-lbl">Not Visited</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent appointments preview -->
      <div class="data-card">
        <div class="data-card-header">
          <i class="bi bi-calendar-check text-primary"></i>
          <h6>Recent Appointments</h6>
          <button class="btn btn-outline-primary btn-sm ms-auto" onclick="showSection('appointments',null)">
            View All <i class="bi bi-arrow-right ms-1"></i>
          </button>
        </div>
        <div id="recentApptsTable" class="table-responsive"></div>
      </div>
    </div>

    <!-- ── APPOINTMENTS ────────────────────────────────────── -->
    <div id="sectionAppointments" style="display:none">
      <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
        <h6 class="fw-bold mb-0 me-auto">All Appointments</h6>
        <select class="form-select form-select-sm" style="width:auto" id="apptFilterStatus" onchange="renderAdminAppointments(this.value)">
          <option value="ALL">All Statuses</option>
          <option value="BOOKED">Booked</option>
          <option value="VISITED">Visited</option>
          <option value="NOT_VISITED">Not Visited</option>
          <option value="POSTPONED_BY_PATIENT">Postponed by Patient</option>
          <option value="POSTPONED_BY_DOCTOR">Postponed by Doctor</option>
        </select>
      </div>
      <div class="data-card">
        <div id="adminApptsContainer" class="table-responsive"></div>
      </div>
    </div>

    <!-- ── PATIENTS ────────────────────────────────────────── -->
    <div id="sectionPatients" style="display:none">
      <div class="d-flex align-items-center gap-3 mb-3">
        <h6 class="fw-bold mb-0 me-auto">Registered Patients</h6>
        <a href="add-patient.html" class="btn btn-primary btn-sm fw-semibold">
          <i class="bi bi-person-plus me-1"></i>Add Patient
        </a>
      </div>
      <div class="data-card">
        <div class="p-3 border-bottom">
          <input type="text" class="form-control form-control-sm" placeholder="Search name or phone…"
            oninput="filterPatients(this.value)">
        </div>
        <div class="table-responsive" id="tableWrapper"></div>
      </div>
    </div>

  </div>
</div>

<!-- ══ DOCTOR POSTPONE MODAL ══════════════════════════════════ -->
<div class="modal fade" id="docPostponeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header" style="background:#0050ff;color:#fff">
        <h5 class="modal-title fw-bold"><i class="bi bi-clock-history me-2"></i>Postpone — Doctor Side</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="alert alert-info border-0 mb-3 small">
          <i class="bi bi-info-circle me-1"></i>
          This will mark the appointment as <strong>POSTPONED_BY_DOCTOR</strong> and update the patient's dashboard.
        </div>
        <p class="small p-3 bg-light rounded mb-3" id="docPostponeInfo"></p>
        <div id="docPostponeAlert"></div>
        <div class="mb-3">
          <label class="form-label fw-semibold">New Date <span class="text-danger">*</span></label>
          <input type="date" class="form-control" id="docNewDate">
        </div>
        <div class="mb-2">
          <label class="form-label fw-semibold">New Time <span class="text-danger">*</span></label>
          <input type="time" class="form-control" id="docNewTime">
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn fw-semibold px-4" style="background:#0050ff;color:#fff" onclick="submitDocPostpone()">
          <i class="bi bi-clock-history me-1"></i>Postpone Appointment
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ══ PATIENTS MODAL (legacy) — kept for API ════════════════ -->
<div id="patientsModal" style="display:none"></div>
<div id="patientTableContainer" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/dashboard.js"></script>
<script>
// ── Section switcher ──────────────────────────────────────────
const SECTIONS = { overview: 'sectionOverview', appointments: 'sectionAppointments', patients: 'sectionPatients' };
const TITLES   = { overview: 'Overview', appointments: 'Appointments', patients: 'Patients' };

function showSection(key, linkEl) {
  Object.values(SECTIONS).forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  const target = document.getElementById(SECTIONS[key]);
  if (target) target.style.display = '';

  document.querySelectorAll('.sidebar-nav .nav-link').forEach(l => l.classList.remove('active'));
  if (linkEl) linkEl.classList.add('active');
  document.getElementById('topbarTitle').textContent = TITLES[key] || key;

  if (key === 'appointments') renderAdminAppointments('ALL');
  if (key === 'patients')     renderPatientsSection();
  return false;
}

// ── Patients section (inline) ─────────────────────────────────
function renderPatientsSection() {
  const patients = getPatients();
  const wrapper  = document.getElementById('tableWrapper');
  if (!wrapper) return;
  if (!patients.length) {
    wrapper.innerHTML = `<div class="text-center py-5 text-muted"><i class="bi bi-people fs-1"></i><p class="mt-2">No patients yet.</p></div>`;
    return;
  }
  wrapper.innerHTML = buildPatientTable(patients);
}

// Override filterPatients to use inline section
const _origFilterPatients = typeof filterPatients === 'function' ? filterPatients : null;
function filterPatients(q) {
  const patients = getPatients().filter(p =>
    p.name.toLowerCase().includes(q.toLowerCase()) || p.phone.includes(q));
  const w = document.getElementById('tableWrapper');
  if (w) w.innerHTML = buildPatientTable(patients);
}

// ── Recent appointments (overview) ───────────────────────────
function renderRecentAppts() {
  const container = document.getElementById('recentApptsTable');
  if (!container) return;
  const appts = getAppointments().sort((a,b) => new Date(b.bookedAt)-new Date(a.bookedAt)).slice(0,5);

  if (!appts.length) {
    container.innerHTML = `<div class="text-center py-4 text-muted small">No appointments yet.</div>`;
    return;
  }

  container.innerHTML = `
    <table class="table mb-0">
      <thead><tr><th>Patient</th><th>Doctor</th><th>Hospital</th><th>Date</th><th>Status</th><th></th></tr></thead>
      <tbody>
        ${appts.map(a => `
          <tr>
            <td><strong>${a.patientName}</strong><small class="d-block text-muted">${a.patientPhone}</small></td>
            <td>${a.doctorName}<small class="d-block text-muted">${a.specialization}</small></td>
            <td><small>${a.hospitalName}</small></td>
            <td><small>${formatDate(a.consultDate)}<br>${a.consultTime}</small></td>
            <td>${statusBadgeHTML(a.status)}</td>
            <td>
              ${a.status === 'BOOKED' ? `
                <button class="btn btn-xs btn-success me-1" onclick="adminConfirmVisit('${a.id}')" title="Mark Visited">
                  <i class="bi bi-qr-code-scan"></i>
                </button>
                <button class="btn btn-xs btn-warning" onclick="adminPostponeModal('${a.id}')" title="Postpone">
                  <i class="bi bi-clock-history"></i>
                </button>` : ''}
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

// ── Not-visited count ─────────────────────────────────────────
function extraStats() {
  const notVisited = document.getElementById('notVisitedCount');
  if (notVisited) notVisited.textContent = getAppointments().filter(a => a.status === 'NOT_VISITED').length;
}

function refreshAll() {
  loadStats();
  renderRecentAppts();
  extraStats();
  const activeSection = document.querySelector('.sidebar-nav .nav-link.active');
  if (activeSection && activeSection.href.includes('appointments')) renderAdminAppointments('ALL');
  if (activeSection && activeSection.href.includes('patients'))    renderPatientsSection();
  showToast('Dashboard refreshed!', 'primary');
}

// ── Override adminConfirmVisit to also update overview ────────
const _origConfirmVisit = adminConfirmVisit;
function adminConfirmVisit(id) {
  confirmVisit(id);
  renderAdminAppointments(document.getElementById('apptFilterStatus')?.value || 'ALL');
  renderRecentAppts();
  loadStats();
  extraStats();
  showToast('Patient visit confirmed!', 'success');
}

// ── Init ──────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  loadStats();
  renderRecentAppts();
  extraStats();
  setupAppointmentsTab();
});
</script>
</body>
</html>